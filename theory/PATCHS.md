# Створення патчів

При безпосередньому використанні Git'а створення патчів у потрібній формі дуже просте
і використовує лише базові команди. Наприклад, якщо ви хочете створити патч з усіма змінами,
внесеними з моменту останнього комміту, ви можете просто зробити наступне: 
```bash
git diff > patch_file
```
і зберегти результат у файлі патчу (звісно, ви також можете отримати різницю між двома
коммітами або двома тегами тощо). 

Ви також можете створювати патчі іншими способами з більш тонким контролем.
Основною командою для створення патчів є git format-patch. Аргументи, які передаються,
визначають, які і скільки патчів буде створено.

Наприклад:
```bash
git format-patch -3
```
буде створено файл виправлень для кожного з трьох останніх коммітів з такими назвами: 

`0001-This-is-the-first-commit.patch`

`0002-This-is-the-second-commit.patch`

де назви згенеровано з повідомлень про комміти, і вони послідовно впорядковані в
хронологічній послідовності.Кожен патч буде охоплювати всі файли, які було змінено
у комміті, в єдиному патчі. 

Можна також зробити щось таке:
```bash
git format-patch main
```
щоб отримати всі зміни з моменту виходу гілки з основної гілки, або використати будь-який
ідентифікатор або тег комміту, а також вказати діапазон коммітів.

Існує багато інших варіантів. Хорошим варіантом є `--signoff` або `-s`, який додає рядок у вигляді: 

`Signed-off-by: A Smart Guy <asmartguy@linux.com>`

відповідно до налаштувань у вашому файлі конфігурації. Це дозволяє чітко простежити,
хто і що зробив, і є обов'язковою у деяких проєктах, наприклад, у ядрі Linux.

## Надсилання поштою

Недивно, що команда для безпосереднього надсилання патчів електронною поштою `git send-email`.
Щоб надіслати повідомлення до списку розсилки ядра Linux, вам слід скористатися цією командою: 
```bash
git send-email -to linux-kernel@vger.kernel.org 0001-This-is-the-first-commit.patch
```

При цьому вам буде запропоновано ввести певну інформацію, наприклад, від кого надходить повідомлення.
Також можна вказати додаткову інформацію, наприклад, конфігурацію вашого поштового агента `smtp`,
а також додаткових одержувачів надісланого електронною поштою патча.

Ми не розглядаємо, чи працюватиме це без внесення змін до налаштувань пошти у вашій системі
(наприклад, можливого переналаштування `sendmail`) і як виправити будь-які проблеми, оскільки
це може бути складно, залежно від конфігурації вашої системи, і це може бути неможливо зробити,
не будучи привілейованим користувачем.

Втім, немає необхідності використовувати команду `git send-email`. Ви можете використовувати
будь-який поштовий клієнт, до якого ви звикли, наприклад, `thunderbird`, `evolution`, `mutt` тощо.
Але, якщо ви використовуєте звичайний поштовий клієнт, ви повинні бути обережними, щоб не зіпсувати
патч в процесі розсилки:

Вимкніть будь-яке кодування `html` і надсилайте звичайний текст `ASCII`.
Вимкніть будь-яке обтікання рядків або обтікання тексту.
Загалом, більшість розробників надають перевагу вбудовуванню патчів безпосередньо
у повідомлення електронної пошти, а не використанню вкладень, які (окрім того, що
вимагають додаткових кроків для перегляду) можуть виявити інші особливості поштових
клієнтів. Навіть для дуже довгих патчів вкладення будуть не варто використовувати.

## Застосування патчів

В ідеальному світі застосовувати патчі так само просто, як і робити:
```bash
git am 0002-This-is-the-second-commit.patch
```
за умови, що ви перебуваєте у гілці, до якої ще не було внесено зміни до патчів.
Ця команда є дуже потужною; вона не лише застосовує патчі до робочих копій у
каталогах вашого проєкту, але й коммітить. 

Цілком можливо, що один або кілька патчів не буде застосовано через суперечливі
лінії розробки між відправником та отримувачем патчів. Такі проблеми доведеться
вирішувати по черзі. Наприклад, ви можете отримати повідомлення на кшталт: 
```bash
error: patch failed: file2:1
error: file2: patch does not apply
Patch failed at 0001.
```

Коли ви вирішите цю проблему, виконайте `git am --resolved`.
Якщо ви бажаєте пропустити цей патч, виконайте `git am --skip`.

Ви також можете відкопіювати патчі і відновити початкову гілку за допомогою:
```bash
git am --abort
```
Можливо, ви надасте перевагу більш обережному виконанню робіт вручну.
Ви можете застосувати окремі патчі безпосередньо до вашої робочої копії.
Наприклад, ви можете спробувати: 
```bash
patch --dry-run < 0002-This-is-the-second-commit.patch
```
Якщо проблем не виникло, запустіть ще раз без опції `--dry-run`.
Після цього вам потрібно буде запустити git add для відповідних файлів і, зрештою, зробити `git commit`.

Існує ще одна команда нижчого рівня, `git apply`, яка є основою `git am`. Якщо ви зробите ось це:
```bash
git apply --check 0002-This-is-the-second-commit.patch
```
вона працює як `patch --dry-run`. Насправді вона не виконає виправлення.
Якщо проблем не виникло, ви можете запустити команду ще раз без
параметра `--check`. Це виправить робочі файли у ваших каталогах і
оновить зміст (індекс). Зрештою, вам все одно доведеться
викликати `git add` і `git commit`. 

`git apply` не змінює зміст (індекс). Ви також можете використовувати `--cachedd`,
щоб застосувати зміни лише до змісту (індексу).

|Команда|Вихідні файли|Зміст (Index)|Ланцюжок коммітів|Посилання|
|-------|-------------|-------------|-----------------|---------|
|git am|Змінено на основі патчу|Оновлено для відображення патчу|Створено новий об'єкт комміта та додано на початок ланцюжка коммітів|HEAD: вказує на новий об'єкт комміту|
|git apply|Змінено на основі патчу (якщо не вказано параметр __--check__)|Змінено на основі патчу (якщо не вказано параметр __--index__)|Без змін|Без змін|